<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>CMSIS-RTOS RTX Tutorial</title>
<title>CMSIS-RTOS RTX: CMSIS-RTOS RTX Tutorial</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="cmsis.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylsheetf" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 46px;">
  <td id="projectlogo"><img alt="Logo" src="CMSIS_Logo_Final.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">CMSIS-RTOS RTX
   &#160;<span id="projectnumber">Version 4.78</span>
   </div>
   <div id="projectbrief">CMSIS-RTOS RTX: Real-Time Operating System for Cortex-M processor-based devices</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="CMSISnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Usage&#160;and&#160;Description</span></a></li>
      <li><a href="modules.html"><span>Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_example_r_t_x__tutorial.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">CMSIS-RTOS RTX Tutorial </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial gives you an easy to follow step-by-step introduction into the basic concepts of a real-time operating system. It is based on CMSIS-RTOS RTX and tries to be generic so that it can be used with any underlying Cortex-M based hardware. The tutorial is divided into the following sections:</p>
<ul>
<li><a class="el" href="_example_r_t_x__tutorial.html#RTX_Tutorial_Start">RTOS Blinky</a> : Provides an easy start for beginners. At the end of this tutorial, an LED will flash on your development board.</li>
<li><a class="el" href="_example_r_t_x__tutorial.html#RTX_Tutorial_Idle">Idle Demon</a> : Shows how to use the Idle task to manage the runtime and energy consumption of your program.</li>
<li><a class="el" href="_example_r_t_x__tutorial.html#RTX_Tutorial_Signals">Signals</a> : Demonstrates how to use <b>signals</b> for inter-thread communication.</li>
<li><a class="el" href="_example_r_t_x__tutorial.html#RTX_Tutorial_SVC">Supervisor Calls (SVC)</a> : Gives an example of how to integrate ISRs with an RTOS.</li>
<li><a class="el" href="_example_r_t_x__tutorial.html#RTX_Tutorial_Semaphores">Semaphores</a> : Explains how to manage and protect access to shared resources.</li>
<li><a class="el" href="_example_r_t_x__tutorial.html#RTX_Tutorial_Mutexes">Mutexes</a> : Shows how to synchronize the execution of threads using <b>mutexes</b>.</li>
<li><a class="el" href="_example_r_t_x__tutorial.html#RTX_Tutorial_Messages">Messages</a> : Demonstrates how to pass <b>messages</b> from one thread to another.</li>
<li><a class="el" href="_example_r_t_x__tutorial.html#RTX_Tutorial_Mailboxes">Mailbox</a> : Explains how to send <b>mails</b> from one thread to another.</li>
</ul>
<h1><a class="anchor" id="RTX_Tutorial_Start"></a>
RTOS Blinky</h1>
<p>Start by opening uVision. Select <b>Project</b> and then <b>New uVision Project...</b>. In the window that opens, press <b>New Folder</b> and name the new folder <b>RTOS</b>. Click <b>Open</b>. Then, enter in the <b>File name</b> box <b>RTOS</b> and click on <b>Save</b>.</p>
<div class="image">
<img src="rtosTut_CreateNewProject.png" alt="rtosTut_CreateNewProject.png"/>
<div class="caption">
Create new project dialog</div></div>
<p>A new window opens that asks you to select your target device. In this tutorial, the LPC1857 will be used, but any supported device will be ok (please do not forget to use <b>Pack Installer</b> to install support for your target device before creating a new project).</p>
<p>Enter <b>LPC1857</b> in the <b>Search</b> box, click on the device and click <b>OK:</b> </p>
<div class="image">
<img src="rtosTut_SelectDevice.png" alt="rtosTut_SelectDevice.png"/>
<div class="caption">
Select your target device</div></div>
<p>The <b>Manage Run-Time Environment</b> window opens that allows us to select the required software components for the project. Select the following components:</p>
<ul>
<li>Board Support (Variant MCB1800):LED (API):LED</li>
<li>CMSIS:RTOS (API):Keil RTX</li>
</ul>
<p>Then, press the <b>Resolve</b> button and then <b>OK</b>.</p>
<div class="image">
<img src="rtosTut_ManageRTE.png" alt="rtosTut_ManageRTE.png"/>
<div class="caption">
Select required software components</div></div>
<dl class="section note"><dt>Note</dt><dd>If you development board does not have a <b>Board Support</b> entry, simply create two functions (LED_On/LED_Off) so that the rest of the code of this tutorial will run on your hardware. Refer to the <a href="http://www.keil.com/pack/doc/mw/Board/html/group__bsp__led.html" target="_blank">Board Support</a> documentation for more information.</dd></dl>
<p>The <b>Project</b> window will show all software components that are added to the project:</p>
<div class="image">
<img src="rtosTut_ProjWindow.png" alt="rtosTut_ProjWindow.png"/>
<div class="caption">
Software components in the Project window</div></div>
<p>The green diamonds are the software component packages. The files with yellow keys are linked from the software pack and write protected. The remaining files are configuration files:</p>
<ul>
<li>startup_lpc1800xx.s for stack and heap configuration</li>
<li>RTE_Device.h to configure the device's peripheral interfaces</li>
<li><b>RTX_Conf_CM.c</b> for configuring CMSIS-RTOS RTX</li>
</ul>
<p>The Keil RTX software pack provides various <b>user code templates</b>. We add the template for the <b>main</b> function. Right-click on <b>Source Group 1</b> and select <b>Add New Item to Group ‘Source Group 1’...</b>.</p>
<div class="image">
<img src="rtosTut_AddNewItem.png" alt="rtosTut_AddNewItem.png"/>
<div class="caption">
Add New Item to Group</div></div>
<p>Click on <b>User Code Template</b> and select <b>CMSIS-RTOS ‘main’ function</b>. Press <b>Add</b>. This adds the file <b>main.c</b> to Source Group 1.</p>
<div class="image">
<img src="rtosTut_AddNewItemUCT.png" alt="rtosTut_AddNewItemUCT.png"/>
<div class="caption">
Add user code template 'CMSIS-RTOS main function'</div></div>
<p>Add a second user code template: select <b>CMSIS-RTOS Thread</b> and press <b>Add</b>. Add a third user code template by selecting <b>CMSIS-RTOS Thread</b> again. Name it <b>Thread_1.c</b> before pressing the <b>Add</b> button.</p>
<div class="image">
<img src="rtosTut_AddNewItemUCTThread_1.png" alt="rtosTut_AddNewItemUCTThread_1.png"/>
<div class="caption">
Add user code template 'CMSIS-RTOS Thread'</div></div>
<p>Source Group 1 should look like this:</p>
<div class="image">
<img src="rtosTut_SourceGroup1.png" alt="rtosTut_SourceGroup1.png"/>
<div class="caption">
Source Group 1 after adding the three templates</div></div>
<h2>Adapt Thread_1.c</h2>
<p>The file <b>Thread_1.c</b> should be open. Change the code as follows:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> Thread_1 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);          </div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> tid_Thread_1;                       </div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a> (Thread_1, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa45a2895ad30c79fb97de18cac7cc19f1" title="priority: normal (default)">osPriorityNormal</a>, 1, 0);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> Init_Thread_1 (<span class="keywordtype">void</span>) {</div>
<div class="line">  tid_Thread_1 = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a> (<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(Thread_1), NULL);</div>
<div class="line">  <span class="keywordflow">if</span>(!tid_Thread_1) <span class="keywordflow">return</span>(-1);</div>
<div class="line">  <span class="keywordflow">return</span>(0);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> Thread_1 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line">  <span class="keywordflow">while</span> (1) {</div>
<div class="line">    ; <span class="comment">// Insert thread code here...</span></div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf13a667493c5d629a90c13e113b99233" title="Pass control to next thread that is in state READY.">osThreadYield</a>(); </div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd><ul>
<li>Change the object names to <b>Thread_1</b> as shown above. This creates two threads: <b>Thread</b> and <b>Thread_1</b> </li>
<li>Warning: in <b>Init_Thread_1 (void)</b> make sure to change <b>osThread(Thread_1)</b> as well.</li>
</ul>
</dd></dl>
<h2>Adapt main.c</h2>
<p>Click on the <b>main.c</b> tab and change the code as follows:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define osObjectsPublic </span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &quot;osObjects.h&quot;</span>  </div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span> Init_Thread   (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span> Init_Thread_1 (<span class="keywordtype">void</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* main: initialize and start the system */</span></div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">void</span>) {</div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#ga53d078a801022e202e8115c083ece68e" title="Initialize the RTOS Kernel for creating objects.">osKernelInitialize</a> ();</div>
<div class="line">  <span class="comment">// initialize peripherals here</span></div>
<div class="line">  <span class="comment">// create &#39;thread&#39; functions that start executing,</span></div>
<div class="line">  Init_Thread();</div>
<div class="line">  Init_Thread_1();</div>
<div class="line">  <span class="comment">// example: tid_name = osThreadCreate (osThread(name), NULL);</span></div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#gaab668ffd2ea76bb0a77ab0ab385eaef2" title="Start the RTOS Kernel.">osKernelStart</a> ();</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Adapt Thread.c</h2>
<p>Click on the <b>Thread.c</b> tab and change the code as follows:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cmsis__os_8h.html">cmsis_os.h</a>&gt;</span> </div>
<div class="line"><span class="preprocessor">#include &quot;Board_LED.h&quot;</span></div>
<div class="line"> </div>
<div class="line">:</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> Thread (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line">  LED_Initialize();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span> (1) {</div>
<div class="line">    LED_On(0);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(1000);</div>
<div class="line">    LED_Off(0);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(1000);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd><ul>
<li>Add the header file <b>#include “Board_LED.h”</b></li>
<li>In the thread code add the <b>LED_initilize()</b> function</li>
<li>In the while loop add the code to flash the user LED</li>
<li><a class="el" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay()</a> is a CMSIS-RTOS function which provides a delay in milliseconds</li>
<li>Warning: If you forget to add <b>LED_Initilize()</b>, the code will build but the LEDs will not flash</li>
</ul>
</dd></dl>
<h2>Adapt Thread_1.c (again)</h2>
<p>Click on the <b>Thread_1.c</b> tab and do the same as for Thread.c. Change the LED number to 1:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cmsis__os_8h.html">cmsis_os.h</a>&gt;</span> </div>
<div class="line"><span class="preprocessor">#include &quot;Board_LED.h&quot;</span></div>
<div class="line"> </div>
<div class="line">:</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> Thread_1 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line">  LED_Initialize();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span> (1) {</div>
<div class="line">    LED_On(1);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(1000);</div>
<div class="line">    LED_Off(1);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(1000);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Configure CMSIS-RTOS RTX</h2>
<p>Double-click on <b>RTX_Conf_CM.c</b> and select the <b>Configuration Wizard</b>. Press <b>Expand All</b>.</p>
<div class="image">
<img src="rtosTut_RTX_Conf_CM.png" alt="rtosTut_RTX_Conf_CM.png"/>
<div class="caption">
Configuration of CMSIS-RTOS RTX</div></div>
<p>Set the <b>RTOS Kernel Timer input clock frequency [Hz]</b> to <b>180000000</b> as this is the core clock frequency of our target device. Not setting this correctly, will result in a wrong LED flashing interval.</p>
<h2>Save and build the program</h2>
<p>Select <b>File</b> and then <b>Save All</b> (you might see an info box that the project is saved in the new .uvprojx format). Select <b>Project</b> and then <b>Build target</b> or press F7 to build the complete project. It should build without any errors or warnings:</p>
<div class="image">
<img src="rtosTut_BuildOutput.png" alt="rtosTut_BuildOutput.png"/>
<div class="caption">
Build output</div></div>
<h2>Configure the debugger</h2>
<p>Select <b>Project</b> and then <b>Options for Target 'Target 1'...</b> or press <b>ALT+F7</b> to set the options for your target.</p>
<h2>Debugging</h2>
<ul>
<li>Press <b>CTRL+F5</b> to start a <b>Debug</b> session.</li>
<li>Run the code (<b>F5</b>).</li>
</ul>
<h1><a class="anchor" id="RTX_Tutorial_Idle"></a>
Idle Demon</h1>
<p>If no thread is running, CMSIS-RTOS RTX will enter an idle thread. The default idle thread is stored in <b>RTX_Conf_CM.c</b>. It is called <b>os_idle_demon</b>. Typically, power management code can be added here:</p>
<div class="fragment"><div class="line"><span class="comment">/*--------------------------- os_idle_demon ---------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group___r_t_x___global___functions.html#gafb4dc4d3dff8343a393726d2860282e4" title="The idle demon is running when no other thread is ready to run.">os_idle_demon</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">/* The idle demon is a system thread, running when no other thread is      */</span></div>
<div class="line">  <span class="comment">/* ready to run.                                                           */</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    <span class="comment">/* HERE: include optional user code to be executed when no thread runs.*/</span></div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>The idle demon tutorial runs in simulator mode so that no actual hardware is required. Install the <b>Keil::STM32F1xx_DFP</b> containing the <b>STM32F103RB</b> device. Setup the project:</p>
<ol type="1">
<li>Create a project called <b>Idle</b> and select the <b>STM32F103RB</b> as the target device.</li>
<li>Select the <b>CMSIS:RTOS (API):Keil RTX</b> software component and resolve any validation problems.</li>
<li>Add the <b>CMSIS-RTOS 'main' function</b> user code template to the project.</li>
<li>Add a C source file called <b>led.c</b> to the project.</li>
<li>Add a header file called <b>led.h</b> to the project.</li>
</ol>
<h2>Adapt led.h</h2>
<p>Click on the <b>led.h</b> tab and add these lines of code: </p>
<div class="fragment"><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> LED_Init (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> LED_On(uint32_t output); </div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> LED_Off(uint32_t output);</div>
</div><!-- fragment --><h2>Adapt led.c</h2>
<p>Click on the <b>led.c</b> tab and add the following: </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;stm32f10x.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> LED_Init (<span class="keywordtype">void</span>) {</div>
<div class="line">  GPIOB-&gt;CRH = 0x33333333;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> LED_On(uint32_t output) {</div>
<div class="line">  GPIOB-&gt;ODR |= output &lt;&lt; 8;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> LED_Off(uint32_t output) {</div>
<div class="line">  GPIOB-&gt;ODR &amp;= ~(output &lt;&lt; 8);</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Adapt main.c</h2>
<p>Click on the <b>main.c</b> tab and edit the code as follows: </p>
<div class="fragment"><div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">   CMSIS-RTOS &#39;main&#39; function template</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define osObjectsPublic                     // define objects in main module</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &quot;osObjects.h&quot;</span>                      <span class="comment">// RTOS object definitions</span></div>
<div class="line"><span class="preprocessor">#include &quot;stm32f10x.h&quot;</span>                  <span class="comment">// Device header</span></div>
<div class="line"><span class="preprocessor">#include &quot;led.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">  Thread 1 &#39;led1&#39;: toggles the LED 1</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">void</span> led1 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) </div>
<div class="line">{</div>
<div class="line">        <span class="keywordflow">for</span> (;;) </div>
<div class="line">        {</div>
<div class="line">                LED_On(1);                          <span class="comment">// Toggle LED1                      </span></div>
<div class="line">                <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(500);</div>
<div class="line">                LED_Off(1);</div>
<div class="line">                <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(500);</div>
<div class="line">        }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">  Thread 2 &#39;led2&#39;: toggles the LED 2</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">void</span> led2 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) </div>
<div class="line">{</div>
<div class="line">        <span class="keywordflow">for</span> (;;) </div>
<div class="line">        {</div>
<div class="line">    LED_On(2);                          <span class="comment">// Toggle LED2                       </span></div>
<div class="line">                <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(100);</div>
<div class="line">                LED_Off(2);</div>
<div class="line">                <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(100);</div>
<div class="line">        }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> main_ID;     </div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a>(led1, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa45a2895ad30c79fb97de18cac7cc19f1" title="priority: normal (default)">osPriorityNormal</a>, 1, 0);</div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a>(led2, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa45a2895ad30c79fb97de18cac7cc19f1" title="priority: normal (default)">osPriorityNormal</a>, 1, 0);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">   main: initialize and start the system</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">void</span>) {</div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#ga53d078a801022e202e8115c083ece68e" title="Initialize the RTOS Kernel for creating objects.">osKernelInitialize</a> ();                    <span class="comment">// initialize CMSIS-RTOS</span></div>
<div class="line">        </div>
<div class="line">  <span class="comment">// initialize peripherals here</span></div>
<div class="line">  LED_Init();</div>
<div class="line">  <span class="comment">// create &#39;thread&#39; functions that start executing,</span></div>
<div class="line">  <span class="comment">// example: tid_name = osThreadCreate (osThread(name), NULL);</span></div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a>(<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(led1), NULL);</div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a>(<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(led2), NULL);</div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#gaab668ffd2ea76bb0a77ab0ab385eaef2" title="Start the RTOS Kernel.">osKernelStart</a> ();                         <span class="comment">// start thread execution </span></div>
<div class="line">}</div>
</div><!-- fragment --><h2>Configure CMSIS-RTOS RTX</h2>
<p>Double-click on <b>RTX_Conf_CM.c</b> and select the <b>Configuration Wizard</b>. Press <b>Expand All</b>. Set the <b>RTOS Kernel Timer input clock frequency [Hz]</b> to <b>16000000</b>.</p>
<h2>Save and build the program</h2>
<p>Select <b>File</b> and then <b>Save All</b> (you might see an info box that the project is saved in the new .uvprojx format). Select <b>Project</b> and then <b>Build target</b> or press F7 to build the complete project. It should build without any errors or warnings.</p>
<h2>Configure the target</h2>
<p>Select <b>Project</b> and then <b>Options for Target 'Target 1'...</b> or press <b>ALT+F7</b> to set the options for your target. Select the <b>Debug</b> tab and select <b>Use Simulator</b>. In the <b>Dialog DLL</b> box enter <b>DARMSTM.DLL</b> and in the <b>Parameter</b> box enter <b>-pSTM32F103RB</b>:</p>
<div class="image">
<img src="rtosTut_TargetOptionsSimulator.png" alt="rtosTut_TargetOptionsSimulator.png"/>
<div class="caption">
Simulator Settings</div></div>
<h2>Debugging</h2>
<p>Press <b>CTRL+F5</b> to start a <b>Debug</b> session. As this program runs in simulator mode, we can make use of the advanced debugging tools of uVision without using a debug probe. Go to <b>View</b> -&gt; <b>Analysis Windows</b> -&gt; <b>Performance Analyzer</b>. Expand the tree to see the time spent in the idle demon.</p>
<div class="image">
<img src="rtosTut_IdlePerfAnalyzer.png" alt="rtosTut_IdlePerfAnalyzer.png"/>
<div class="caption">
Performance Analyzer showing the time spent in Idle</div></div>
<h2>Adapt the Idle Demon</h2>
<p>Leave the <b>Debug</b> session by pressing <b>CTRL+F5</b> again and open the <b>RTX_Conf_CM.c</b> file in <b>Text Editor</b> mode. Find the <b>os_idle_demon</b> function and change the code to the following: </p>
<div class="fragment"><div class="line"><span class="comment">/*--------------------------- os_idle_demon ---------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group___r_t_x___global___functions.html#gafb4dc4d3dff8343a393726d2860282e4" title="The idle demon is running when no other thread is ready to run.">os_idle_demon</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">/* The idle demon is a system thread, running when no other thread is      */</span></div>
<div class="line">  <span class="comment">/* ready to run.                                                           */</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    <span class="comment">/* HERE: include optional user code to be executed when no thread runs.*/</span></div>
<div class="line">    __wfi();</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>The __wfi() function waits for an interrupt to happen. This halts the processor until it needs to restart (on a scheduler tick or peripheral interrupt).</dd></dl>
<h2>Check the changed behavior</h2>
<ul>
<li>Rebuild the code by pressing <b>F7</b>.</li>
<li>Enter a <b>Debug</b> session (<b>CTRL+F5</b>).</li>
<li>Run the code (<b>F5</b>).</li>
<li>Find the Idle demon in the Performance Analysis window:</li>
</ul>
<div class="image">
<img src="rtosTut_IdlePerfAnalyzerLowEnergy.png" alt="rtosTut_IdlePerfAnalyzerLowEnergy.png"/>
<div class="caption">
Less processor cycles with __wfi() during Idle</div></div>
<p>The processor is now frozen during Idle cycles. Less processor cycles will lead to a lowered energy consumption during runtime.</p>
<h1><a class="anchor" id="RTX_Tutorial_Signals"></a>
Signals</h1>
<p>In this tutorial, we will be creating two LED threads. led_thread1 will be waiting for a <em>signal</em> that will be set by led_thread2. To be able to see the program flow, led_thread2 will us the <a class="el" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255">osDelay</a> function to wait 500 ms before setting the <em>signal</em> for led_thread1. Here's how the program works:</p>
<div class="image">
<img src="signal_example_flow_chart.png" alt="signal_example_flow_chart.png"/>
<div class="caption">
Simple signal event communication</div></div>
<p>To run the signals tutorial, create a project with the following:</p>
<ol type="1">
<li>Create a project called <b>Signals</b> and select your target device.</li>
<li>Select the <b>Board Support:LED (API):LED</b> (if available; otherwise, create two functions LED_On/LED_Off) and <b>CMSIS:RTOS (API):Keil RTX</b> software components and resolve any validation problems.</li>
<li>Add the <b>CMSIS-RTOS 'main' function</b> user code template to the project.</li>
</ol>
<h2>Adapt main.c</h2>
<p>Click on the <b>main.c</b> tab and change the code to: </p>
<div class="fragment"><div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">   CMSIS-RTOS &#39;main&#39; function template</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define osObjectsPublic                     // define objects in main module</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &quot;osObjects.h&quot;</span>                      <span class="comment">// RTOS object definitions</span></div>
<div class="line"><span class="preprocessor">#include &quot;Board_LED.h&quot;</span>                  <span class="comment">// ::Board Support:LED</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> led_Thread1 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);</div>
<div class="line"><span class="keywordtype">void</span> led_Thread2 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a>(led_Thread1, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa17b36cd9cd38652c2bc6d4803990674b" title="priority: above normal">osPriorityAboveNormal</a>, 1, 0);</div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a>(led_Thread2, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa45a2895ad30c79fb97de18cac7cc19f1" title="priority: normal (default)">osPriorityNormal</a>, 1, 0);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> T_led_ID1;</div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> T_led_ID2;   </div>
<div class="line"> </div>
<div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">  Flash LED 1 when signaled by the led_Thread2</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">void</span> led_Thread1 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___signal_mgmt.html#ga38860acda96df47da6923348d96fc4c9" title="Wait for one or more Signal Flags to become signaled for the current RUNNING thread.">osSignalWait</a> (0x01,<a class="code" href="cmsis__os_8h.html#a9eb9a7a797a42e4b55eb171ecc609ddb" title="Timeout value.">osWaitForever</a>);</div>
<div class="line">    LED_On(0);                          </div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___signal_mgmt.html#ga38860acda96df47da6923348d96fc4c9" title="Wait for one or more Signal Flags to become signaled for the current RUNNING thread.">osSignalWait</a> (0x01,<a class="code" href="cmsis__os_8h.html#a9eb9a7a797a42e4b55eb171ecc609ddb" title="Timeout value.">osWaitForever</a>);  </div>
<div class="line">    LED_Off(0);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">  Flash LED two and synchronize the flashing of LED 1 by setting a signal flag</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">void</span> led_Thread2 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    LED_On(1);          </div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___signal_mgmt.html#ga3de2730654589d6c3559c4b9e2825553" title="Set the specified Signal Flags of an active thread.">osSignalSet</a> (T_led_ID1,0x01);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(500);</div>
<div class="line">    LED_Off(1);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___signal_mgmt.html#ga3de2730654589d6c3559c4b9e2825553" title="Set the specified Signal Flags of an active thread.">osSignalSet</a> (T_led_ID1,0x01);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(500);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">   main: initialize and start the system</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">void</span>) {</div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#ga53d078a801022e202e8115c083ece68e" title="Initialize the RTOS Kernel for creating objects.">osKernelInitialize</a> ();                    <span class="comment">// initialize CMSIS-RTOS</span></div>
<div class="line">        </div>
<div class="line">  <span class="comment">// initialize peripherals here</span></div>
<div class="line">  LED_Initialize();</div>
<div class="line">  <span class="comment">// create &#39;thread&#39; functions that start executing,</span></div>
<div class="line">  <span class="comment">// example: tid_name = osThreadCreate (osThread(name), NULL);</span></div>
<div class="line">  T_led_ID2 = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a>(<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(led_Thread2), NULL);</div>
<div class="line">  T_led_ID1 = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a>(<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(led_Thread1), NULL);      </div>
<div class="line"> </div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#gaab668ffd2ea76bb0a77ab0ab385eaef2" title="Start the RTOS Kernel.">osKernelStart</a> ();                         <span class="comment">// start thread execution </span></div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="el" href="group___c_m_s_i_s___r_t_o_s___signal_mgmt.html#ga38860acda96df47da6923348d96fc4c9">osSignalWait()</a> is now used in led_thread1(). It is triggered by <a class="el" href="group___c_m_s_i_s___r_t_o_s___signal_mgmt.html#ga3de2730654589d6c3559c4b9e2825553">osSignalSet()</a> in led_thread2. This synchronizes the execution of both threads.</p>
<h2>Save, build and debug the program</h2>
<ul>
<li>Select <b>File</b> and then <b>Save All</b>.</li>
<li>Select <b>Project</b> and then <b>Build target</b> or press F7 to build the complete project. It should build without any errors or warnings.</li>
<li>Enter a <b>Debug</b> session (<b>CTRL+F5</b>).</li>
<li>Run the code (<b>F5</b>).</li>
</ul>
<h1><a class="anchor" id="RTX_Tutorial_SVC"></a>
Supervisor Calls (SVC)</h1>
<p>This tutorial will do the following:</p>
<ul>
<li>It configures two LED flashing threads</li>
<li>The two LED threads flash one user LED (on and off)</li>
<li>It configures an external interrupt attached to the user button of the development board (on port A bit 0)</li>
<li>The second user LED is flashed when the user button is pressed:<ul>
<li>The user button is on port A bit 0</li>
<li>The external interrupt controller (EXTI) can be configured to make this pin an external interrupt line</li>
</ul>
</li>
</ul>
<p>To run this tutorial, open the previous one or create it as described in <a class="el" href="_example_r_t_x__tutorial.html#RTX_Tutorial_Signals">Signals</a>. Then</p>
<ul>
<li>Add the <b>CMSIS-RTOS User SVC</b> user code template to the project.</li>
</ul>
<h2>Adapt SVC_Table.s</h2>
<p>Uncomment lines 44 and 49 (remove the <b></b>;): </p>
<div class="fragment"><div class="line">IMPORT  __SVC_1</div>
</div><!-- fragment --> <div class="fragment"><div class="line">DCD     __SVC_1                 ; user SVC <span class="keyword">function</span></div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd><ul>
<li>The SVC_Table.s file provides a lookup table for the software interrupt calls.</li>
<li>For each SVC you use you must import the SVC label and extend the SCV table</li>
</ul>
</dd></dl>
<h2>Adapt main.c</h2>
<p>Open main.c and change it to the following: </p>
<div class="fragment"><div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">   CMSIS-RTOS &#39;main&#39; function template</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define osObjectsPublic                     // define objects in main module</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &quot;osObjects.h&quot;</span>                      <span class="comment">// RTOS object definitions</span></div>
<div class="line"><span class="preprocessor">#include &quot;stm32f4xx.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;stm32f4xx_hal.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Board_LED.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> led_Thread1 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);</div>
<div class="line"><span class="keywordtype">void</span> led_Thread2 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);</div>
<div class="line"><span class="keywordtype">void</span> exti_Thread (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> __svc(1) init_EXTI (<span class="keywordtype">void</span>);             <span class="comment">//Define the EXTI initializing code as a supervisor function</span></div>
<div class="line"> </div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a>(led_Thread1, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa45a2895ad30c79fb97de18cac7cc19f1" title="priority: normal (default)">osPriorityNormal</a>, 1, 0);</div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a>(led_Thread2, osPriorityNormal, 1, 0);</div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a>(exti_Thread, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa17b36cd9cd38652c2bc6d4803990674b" title="priority: above normal">osPriorityAboveNormal</a>, 1, 0);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> T_led_ID1;</div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> T_led_ID2;   </div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> T_exti_ID;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">   EXTI interrupt handler</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">void</span> EXTI0_IRQHandler(<span class="keywordtype">void</span>) {</div>
<div class="line">  __HAL_GPIO_EXTI_CLEAR_IT(GPIO_PIN_0);</div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___signal_mgmt.html#ga3de2730654589d6c3559c4b9e2825553" title="Set the specified Signal Flags of an active thread.">osSignalSet</a>(T_exti_ID,0x01);           </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> exti_Thread (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___signal_mgmt.html#ga38860acda96df47da6923348d96fc4c9" title="Wait for one or more Signal Flags to become signaled for the current RUNNING thread.">osSignalWait</a>(0x01,<a class="code" href="cmsis__os_8h.html#a9eb9a7a797a42e4b55eb171ecc609ddb" title="Timeout value.">osWaitForever</a>);</div>
<div class="line">    LED_On(1);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(500);</div>
<div class="line">    LED_Off(1);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> led_Thread1 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___signal_mgmt.html#ga38860acda96df47da6923348d96fc4c9" title="Wait for one or more Signal Flags to become signaled for the current RUNNING thread.">osSignalWait</a>(0x01,<a class="code" href="cmsis__os_8h.html#a9eb9a7a797a42e4b55eb171ecc609ddb" title="Timeout value.">osWaitForever</a>);</div>
<div class="line">    LED_Off(0);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> led_Thread2 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line">  LED_Initialize ();</div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    LED_On(0);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(500);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___signal_mgmt.html#ga3de2730654589d6c3559c4b9e2825553" title="Set the specified Signal Flags of an active thread.">osSignalSet</a>(T_led_ID1,0x01);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(500);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">main: initialize and start the system</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">void</span>) {</div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#ga53d078a801022e202e8115c083ece68e" title="Initialize the RTOS Kernel for creating objects.">osKernelInitialize</a> ();</div>
<div class="line">  init_EXTI();                              <span class="comment">//initialize the external interrupts</span></div>
<div class="line">  T_led_ID1 = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a>(<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(led_Thread1), NULL);</div>
<div class="line">  T_led_ID2 = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a>(<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(led_Thread2), NULL);</div>
<div class="line">  T_exti_ID = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a>(<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(exti_Thread), NULL);</div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#gaab668ffd2ea76bb0a77ab0ab385eaef2" title="Start the RTOS Kernel.">osKernelStart</a> ();                         <span class="comment">// start thread execution                </span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> __svc(1) init_EXTI (<span class="keywordtype">void</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> __SVC_1 (<span class="keywordtype">void</span>) {</div>
<div class="line">  GPIO_InitTypeDef GPIO_InitStruct;</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* GPIO Ports Clock Enable */</span></div>
<div class="line">  __GPIOA_CLK_ENABLE();</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Configure GPIO pin: GPIOA0 */</span></div>
<div class="line">  GPIO_InitStruct.Pin   = GPIO_PIN_0;</div>
<div class="line">  GPIO_InitStruct.Mode  = GPIO_MODE_IT_RISING;</div>
<div class="line">  GPIO_InitStruct.Pull  = GPIO_PULLDOWN;</div>
<div class="line">  GPIO_InitStruct.Speed = GPIO_SPEED_LOW;</div>
<div class="line">  HAL_GPIO_Init(GPIOA, &amp;GPIO_InitStruct);</div>
<div class="line">  NVIC_EnableIRQ( EXTI0_IRQn );</div>
<div class="line">}</div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>This code works on the STM32F429I-Discovery board. It uses the STM32F4xx HAL for configuring the GPIO pin. To do the same for your hardware, please consult the device's documentation.</dd></dl>
<h2>Save, build and debug the program</h2>
<ul>
<li>Select <b>File</b> and then <b>Save All</b>.</li>
<li>Select <b>Project</b> and then <b>Build target</b> or press F7 to build the complete project. It should build without any errors or warnings.</li>
<li>Enter a <b>Debug</b> session (<b>CTRL+F5</b>).</li>
<li>Run the code (<b>F5</b>).</li>
</ul>
<h1><a class="anchor" id="RTX_Tutorial_Mutexes"></a>
Mutexes</h1>
<p>This tutorial is again running in the µVision simulator (refer to the <a class="el" href="_example_r_t_x__tutorial.html#RTX_Tutorial_Idle">Idle Demon</a> tutorial). Two threads will be created that try to output a stream of either 1's or 2's to the UART.</p>
<p>Install the <b>Keil::STM32F1xx_DFP</b> containing the <b>STM32F103RB</b> device. Setup the project:</p>
<ol type="1">
<li>Create a project called <b>Mutex</b> and select the <b>STM32F103RB</b> as the target device.</li>
<li>Select the <b>CMSIS:RTOS (API):Keil RTX</b> software component and resolve any validation problems.</li>
<li>Add the <b>CMSIS-RTOS 'main' function</b> user code template to the project.</li>
<li>Add a C source file called <b>uart.c</b> to the project.</li>
<li>Add a header file called <b>uart.h</b> to the project.</li>
</ol>
<h2>Adapt uart.h</h2>
<p>Click on the <b>uart.h</b> tab and add these lines of code: </p>
<div class="fragment"><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> USART1_Init (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span> SendChar (<span class="keywordtype">int</span> ch);</div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span> GetKey (<span class="keywordtype">void</span>);</div>
</div><!-- fragment --><h2>Adapt uart.c</h2>
<p>Click on the <b>uart.c</b> tab and add the following: </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stm32F10x.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">  Initialize UART pins, Baudrate</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">void</span> USART1_Init (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="keywordtype">int</span> i;</div>
<div class="line"> </div>
<div class="line">  RCC-&gt;APB2ENR |=  (   1UL &lt;&lt;  0);        <span class="comment">/* enable clock Alternate Function  */</span></div>
<div class="line">  AFIO-&gt;MAPR   &amp;= ~(   1UL &lt;&lt;  2);        <span class="comment">/* clear USART1 remap               */</span></div>
<div class="line"> </div>
<div class="line">  RCC-&gt;APB2ENR |=  (   1UL &lt;&lt;  2);        <span class="comment">/* enable GPIOA clock               */</span></div>
<div class="line">  GPIOA-&gt;CRH   &amp;= ~(0xFFUL &lt;&lt;  4);        <span class="comment">/* clear PA9, PA10                  */</span></div>
<div class="line">  GPIOA-&gt;CRH   |=  (0x0BUL &lt;&lt;  4);        <span class="comment">/* USART1 Tx (PA9) output push-pull */</span></div>
<div class="line">  GPIOA-&gt;CRH   |=  (0x04UL &lt;&lt;  8);        <span class="comment">/* USART1 Rx (PA10) input floating  */</span></div>
<div class="line"> </div>
<div class="line">  RCC-&gt;APB2ENR |=  (   1UL &lt;&lt; 14);        <span class="comment">/* enable USART#1 clock             */</span></div>
<div class="line"> </div>
<div class="line">  USART1-&gt;BRR   = 0x0271;                 <span class="comment">/* 115200 baud @ PCLK2 72MHz        */</span></div>
<div class="line">  USART1-&gt;CR1   = ((   1UL &lt;&lt;  2) |       <span class="comment">/* enable RX                        */</span></div>
<div class="line">                   (   1UL &lt;&lt;  3) |       <span class="comment">/* enable TX                        */</span></div>
<div class="line">                   (   0UL &lt;&lt; 12) );      <span class="comment">/* 1 start bit, 8 data bits         */</span></div>
<div class="line">  USART1-&gt;CR2   = 0x0000;                 <span class="comment">/* 1 stop bit                       */</span></div>
<div class="line">  USART1-&gt;CR3   = 0x0000;                 <span class="comment">/* no flow control                  */</span></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0; i &lt; 0x1000; i++) __NOP();   <span class="comment">/* avoid unwanted output            */</span></div>
<div class="line"> </div>
<div class="line">  USART1-&gt;CR1  |= ((   1UL &lt;&lt; 13) );      <span class="comment">/* enable USART                     */</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">  SendChar</span></div>
<div class="line"><span class="comment">  Write character to Serial Port.</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">int</span> SendChar (<span class="keywordtype">int</span> ch)  {</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span> (!(USART1-&gt;SR &amp; USART_SR_TXE));</div>
<div class="line">  USART1-&gt;DR = (ch &amp; 0x1FF);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> (ch);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">  GetKey</span></div>
<div class="line"><span class="comment">  Read character to Serial Port.</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">int</span> GetKey (<span class="keywordtype">void</span>)  {</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span> (!(USART1-&gt;SR &amp; USART_SR_RXNE));</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> ((<span class="keywordtype">int</span>)(USART1-&gt;DR &amp; 0x1FF));</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Adapt main.c</h2>
<p>Click on the <b>main.c</b> tab and edit the code as follows: </p>
<div class="fragment"><div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">   CMSIS-RTOS &#39;main&#39; function template</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define osObjectsPublic                     // define objects in main module</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &quot;osObjects.h&quot;</span>                      <span class="comment">// RTOS object definitions</span></div>
<div class="line"><span class="preprocessor">#include &quot;stm32f10x.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;uart.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> uart_Thread1 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);</div>
<div class="line"><span class="keywordtype">void</span> uart_Thread2 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);</div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a>(uart_Thread1, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa45a2895ad30c79fb97de18cac7cc19f1" title="priority: normal (default)">osPriorityNormal</a>, 1, 0);</div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a>(uart_Thread2, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa45a2895ad30c79fb97de18cac7cc19f1" title="priority: normal (default)">osPriorityNormal</a>, 1, 0);</div>
<div class="line"> </div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> T_uart1;</div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> T_uart2;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="cmsis__os_8h.html#a3263c1ad9fd79b84f908d65e8da44ac2" title="Mutex ID identifies the mutex (pointer to a mutex control block).">osMutexId</a> uart_mutex;</div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___mutex_mgmt.html#ga9b522438489d7c402c95332b58bc94f3" title="Define a Mutex.">osMutexDef</a>(uart_mutex);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">  Thread two writes the character &#39;1&#39; to UART 1</span></div>
<div class="line"><span class="comment">*---------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">void</span> uart_Thread1 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line">  uint32_t i;</div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    <span class="comment">//osMutexWait(uart_mutex, osWaitForever);</span></div>
<div class="line">    <span class="keywordflow">for</span>( i=0;i&lt;10;i++) {</div>
<div class="line">      SendChar(<span class="charliteral">&#39;1&#39;</span>);</div>
<div class="line">    }</div>
<div class="line">    SendChar(<span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line">    SendChar(<span class="charliteral">&#39;\r&#39;</span>);</div>
<div class="line">    <span class="comment">//osMutexRelease(uart_mutex);</span></div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">  Thread two writes the character &#39;2&#39; to UART 1</span></div>
<div class="line"><span class="comment">*---------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="keywordtype">void</span> uart_Thread2 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line">  uint32_t i;</div>
<div class="line">  <span class="keywordflow">for</span>(;;) {</div>
<div class="line">    <span class="comment">//osMutexWait(uart_mutex, osWaitForever);</span></div>
<div class="line">    <span class="keywordflow">for</span>( i=0;i&lt;10;i++) {</div>
<div class="line">      SendChar(<span class="charliteral">&#39;2&#39;</span>);</div>
<div class="line">    }</div>
<div class="line">    SendChar(<span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line">    SendChar(<span class="charliteral">&#39;\r&#39;</span>);</div>
<div class="line">    <span class="comment">//osMutexRelease(uart_mutex);</span></div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">   main: initialize and start the system</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">void</span>) {</div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#ga53d078a801022e202e8115c083ece68e" title="Initialize the RTOS Kernel for creating objects.">osKernelInitialize</a> ();                    <span class="comment">// initialize CMSIS-RTOS</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// initialize peripherals here</span></div>
<div class="line">        USART1_Init();</div>
<div class="line">        </div>
<div class="line">  <span class="comment">// create &#39;thread&#39; functions that start executing,</span></div>
<div class="line">  <span class="comment">// example: tid_name = osThreadCreate (osThread(name), NULL);</span></div>
<div class="line">  uart_mutex = <a class="code" href="group___c_m_s_i_s___r_t_o_s___mutex_mgmt.html#ga5c9de56e717016e39e788064e9a291cc" title="Create and Initialize a Mutex object.">osMutexCreate</a>(<a class="code" href="group___c_m_s_i_s___r_t_o_s___mutex_mgmt.html#ga1122a86faa64b4a0880c76cf68d0c934" title="Access a Mutex definition.">osMutex</a>(uart_mutex));</div>
<div class="line">  T_uart1 = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a>(<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(uart_Thread1), NULL);</div>
<div class="line">  T_uart2 = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a>(<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(uart_Thread2), NULL);</div>
<div class="line">        <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#gaab668ffd2ea76bb0a77ab0ab385eaef2" title="Start the RTOS Kernel.">osKernelStart</a> ();                       <span class="comment">// start thread execution </span></div>
<div class="line">}</div>
</div><!-- fragment --><h2>Configure CMSIS-RTOS RTX</h2>
<p>Double-click on <b>RTX_Conf_CM.c</b> and select the <b>Configuration Wizard</b>. Press <b>Expand All</b>. Set the <b>RTOS Kernel Timer input clock frequency [Hz]</b> to <b>16000000</b>.</p>
<h2>Save and build the program</h2>
<p>Select <b>File</b> and then <b>Save All</b> (you might see an info box that the project is saved in the new .uvprojx format). Select <b>Project</b> and then <b>Build target</b> or press F7 to build the complete project. It should build without any errors or warnings.</p>
<h2>Configure the target</h2>
<p>Select <b>Project</b> and then <b>Options for Target 'Target 1'...</b> or press <b>ALT+F7</b> to set the options for your target. Select the <b>Debug</b> tab and select <b>Use Simulator</b>. In the <b>Dialog DLL</b> box enter <b>DARMSTM.DLL</b> and in the <b>Parameter</b> box enter <b>-pSTM32F103RB</b>:</p>
<div class="image">
<img src="rtosTut_TargetOptionsSimulator.png" alt="rtosTut_TargetOptionsSimulator.png"/>
<div class="caption">
Simulator Settings</div></div>
<h2>Debugging</h2>
<p>Press <b>CTRL+F5</b> to start a <b>Debug</b> session. Open the <b>View</b> -&gt; <b>Serial Windows</b> -&gt; <b>UART #1</b> window. Press <b>F5</b> to run the program. You will see that both threads try to output to the UART at the same time. Because of the time slicing, the threads corrupt each others output:</p>
<div class="image">
<img src="rtosTut_mutex_garbage_output.png" alt="rtosTut_mutex_garbage_output.png"/>
</div>
<h2>Adding the Mutex</h2>
<p>Previously, the Mutex had already been created in the <b>main</b> thread, but has not been used by the two output threads.</p>
<ul>
<li>Exit the debugger (<b>CTRL+F5</b>).</li>
<li>Uncomment the <a class="el" href="group___c_m_s_i_s___r_t_o_s___mutex_mgmt.html#ga5e1752b73f573ee015dbd9ef1edaba13">osMutexWait</a> and <a class="el" href="group___c_m_s_i_s___r_t_o_s___mutex_mgmt.html#ga006e4744d741e8e132c3d5bbc295afe1">osMutexRelease</a> calls in each thread.</li>
<li>Rebuild the code (<b>F7</b>).</li>
<li>Restart the debugger (<b>CTRL+F5</b>).</li>
<li>Run (<b>F5</b>) the code and observe the new output in the UART window. The Mutex now controls the access to the UART, so that the output streams are now interleaved:</li>
</ul>
<div class="image">
<img src="rtosTut_mutex_output_ok.png" alt="rtosTut_mutex_output_ok.png"/>
</div>
<h1><a class="anchor" id="RTX_Tutorial_Semaphores"></a>
Semaphores</h1>
<p>In some cases, we would like to allow a limited number of threads to access certain resources. For example, an embedded web server might be able to support a limited number of simultaneous requests (due to memory limitations). In such cases, <b>semaphores</b> are used instead of a <b>Mutex</b>.</p>
<p>In this tutorial, we create four threads that each toggle an LED on a development board (make sure that your hardware supports four LEDs, otherwise reduce the number of blinky threads), and use a semaphore to limit the number of active LEDs to 2.</p>
<h2>Project Setup</h2>
<ol type="1">
<li>Create a project called <b>Semaphore</b> and select your target device.</li>
<li>Select the <b>Board Support:LED (API):LED</b> (if available; otherwise, create two functions LED_On/LED_Off) and <b>CMSIS:RTOS (API):Keil RTX</b> software components and resolve any validation problems.</li>
<li>Add the <b>CMSIS-RTOS 'main' function</b> user code template to the project.</li>
<li>Add the <b>CMSIS-RTOS Semaphore</b> user code template to the project.</li>
</ol>
<h2>Adapt Semaphore.c</h2>
<p>Click on the <b>Semaphore.c</b> tab and add these lines of code: </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cmsis__os_8h.html">cmsis_os.h</a>&gt;</span>                                  <span class="comment">// CMSIS RTOS header file</span></div>
<div class="line"><span class="preprocessor">#include &quot;Board_LED.h&quot;</span>                                 <span class="comment">// ::Board Support:LED</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">        Semaphore creation &amp; usage</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> blinky1 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);                   <span class="comment">// thread function blinky1</span></div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> tid_blinky1;                                <span class="comment">// thread id blinky1</span></div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a> (blinky1, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa45a2895ad30c79fb97de18cac7cc19f1" title="priority: normal (default)">osPriorityNormal</a>, 1, 0);         <span class="comment">// thread object blinky1</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> blinky2 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);                   <span class="comment">// thread function blinky2</span></div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> tid_blinky2;                                <span class="comment">// thread id blinky2</span></div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a> (blinky2, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa45a2895ad30c79fb97de18cac7cc19f1" title="priority: normal (default)">osPriorityNormal</a>, 1, 0);         <span class="comment">// thread object blinky2</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> blinky3 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);                   <span class="comment">// thread function blinky3</span></div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> tid_blinky3;                                <span class="comment">// thread id blinky3</span></div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a> (blinky3, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa45a2895ad30c79fb97de18cac7cc19f1" title="priority: normal (default)">osPriorityNormal</a>, 1, 0);         <span class="comment">// thread object blinky3</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> blinky4 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);                   <span class="comment">// thread function blinky4</span></div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> tid_blinky4;                                <span class="comment">// thread id blinky4</span></div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a> (blinky4, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa45a2895ad30c79fb97de18cac7cc19f1" title="priority: normal (default)">osPriorityNormal</a>, 1, 0);         <span class="comment">// thread object blinky4</span></div>
<div class="line"> </div>
<div class="line"><a class="code" href="cmsis__os_8h.html#aa8968896c84094aa973683c84fa06f84" title="Semaphore ID identifies the semaphore (pointer to a semaphore control block).">osSemaphoreId</a> two_LEDs_id;                             <span class="comment">// semaphore id</span></div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___semaphore_mgmt.html#ga9e66fe361749071e5ab87826c43c2f1b" title="Define a Semaphore object.">osSemaphoreDef</a> (two_LEDs);                             <span class="comment">// semaphore object</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> Init_Semaphore (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line">  two_LEDs_id = <a class="code" href="group___c_m_s_i_s___r_t_o_s___semaphore_mgmt.html#ga97381e8e55cd47cec390bf57c96d6edb" title="Create and Initialize a Semaphore object used for managing resources.">osSemaphoreCreate</a>(<a class="code" href="group___c_m_s_i_s___r_t_o_s___semaphore_mgmt.html#ga03761ee8d2c3cd4544e18364ab301dac" title="Access a Semaphore definition.">osSemaphore</a>(two_LEDs), 2);</div>
<div class="line">  </div>
<div class="line">  tid_blinky1  = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a> (<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(blinky1), NULL);</div>
<div class="line">  <span class="keywordflow">if</span>(!tid_blinky1) <span class="keywordflow">return</span>(-1);</div>
<div class="line">  </div>
<div class="line">  tid_blinky2  = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a> (<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(blinky2), NULL);</div>
<div class="line">  <span class="keywordflow">if</span>(!tid_blinky2) <span class="keywordflow">return</span>(-1);</div>
<div class="line">  </div>
<div class="line">  tid_blinky3  = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a> (<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(blinky3), NULL);</div>
<div class="line">  <span class="keywordflow">if</span>(!tid_blinky3) <span class="keywordflow">return</span>(-1);</div>
<div class="line">  </div>
<div class="line">  tid_blinky4  = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a> (<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(blinky4), NULL);</div>
<div class="line">  <span class="keywordflow">if</span>(!tid_blinky4) <span class="keywordflow">return</span>(-1);</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span>(0);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> blinky1(<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span>(1) {</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___semaphore_mgmt.html#gacc15b0fc8ce1167fe43da33042e62098" title="Wait until a Semaphore token becomes available.">osSemaphoreWait</a>(two_LEDs_id, <a class="code" href="cmsis__os_8h.html#a9eb9a7a797a42e4b55eb171ecc609ddb" title="Timeout value.">osWaitForever</a>);</div>
<div class="line">    LED_On(1);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(500);</div>
<div class="line">    LED_Off(1);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___semaphore_mgmt.html#gab108914997c49e14d8ff1ae0d1988ca0" title="Release a Semaphore token.">osSemaphoreRelease</a>(two_LEDs_id);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(500);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> blinky2(<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span>(1) {</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___semaphore_mgmt.html#gacc15b0fc8ce1167fe43da33042e62098" title="Wait until a Semaphore token becomes available.">osSemaphoreWait</a>(two_LEDs_id, <a class="code" href="cmsis__os_8h.html#a9eb9a7a797a42e4b55eb171ecc609ddb" title="Timeout value.">osWaitForever</a>);</div>
<div class="line">    LED_On(1);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(600);</div>
<div class="line">    LED_Off(1);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___semaphore_mgmt.html#gab108914997c49e14d8ff1ae0d1988ca0" title="Release a Semaphore token.">osSemaphoreRelease</a>(two_LEDs_id);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(600);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> blinky3(<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span>(1) {</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___semaphore_mgmt.html#gacc15b0fc8ce1167fe43da33042e62098" title="Wait until a Semaphore token becomes available.">osSemaphoreWait</a>(two_LEDs_id, <a class="code" href="cmsis__os_8h.html#a9eb9a7a797a42e4b55eb171ecc609ddb" title="Timeout value.">osWaitForever</a>);</div>
<div class="line">    LED_On(1);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(700);</div>
<div class="line">    LED_Off(1);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___semaphore_mgmt.html#gab108914997c49e14d8ff1ae0d1988ca0" title="Release a Semaphore token.">osSemaphoreRelease</a>(two_LEDs_id);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(700);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> blinky4(<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span>(1) {</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___semaphore_mgmt.html#gacc15b0fc8ce1167fe43da33042e62098" title="Wait until a Semaphore token becomes available.">osSemaphoreWait</a>(two_LEDs_id, <a class="code" href="cmsis__os_8h.html#a9eb9a7a797a42e4b55eb171ecc609ddb" title="Timeout value.">osWaitForever</a>);</div>
<div class="line">    LED_On(1);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(800);</div>
<div class="line">    LED_Off(1);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___semaphore_mgmt.html#gab108914997c49e14d8ff1ae0d1988ca0" title="Release a Semaphore token.">osSemaphoreRelease</a>(two_LEDs_id);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(800);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Adapt main.c</h2>
<p>Click on the <b>main.c</b> tab and add these lines of code: </p>
<div class="fragment"><div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">   CMSIS-RTOS &#39;main&#39; function template</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define osObjectsPublic                     // define objects in main module</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &quot;osObjects.h&quot;</span>                      <span class="comment">// RTOS object definitions</span></div>
<div class="line"><span class="preprocessor">#include &quot;Board_LED.h&quot;</span>                      <span class="comment">// ::Board Support:LED</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span> Init_Semaphore (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">   main: initialize and start the system</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">void</span>) {</div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#ga53d078a801022e202e8115c083ece68e" title="Initialize the RTOS Kernel for creating objects.">osKernelInitialize</a> ();                    <span class="comment">// initialize CMSIS-RTOS</span></div>
<div class="line">        </div>
<div class="line">  <span class="comment">// initialize peripherals here</span></div>
<div class="line">  LED_Initialize();</div>
<div class="line">  <span class="comment">// create &#39;thread&#39; functions that start executing,</span></div>
<div class="line">  <span class="comment">// example: tid_name = osThreadCreate (osThread(name), NULL);</span></div>
<div class="line">  Init_Semaphore();</div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#gaab668ffd2ea76bb0a77ab0ab385eaef2" title="Start the RTOS Kernel.">osKernelStart</a> ();                         <span class="comment">// start thread execution </span></div>
<div class="line">}</div>
</div><!-- fragment --><h2>Configure CMSIS-RTOS RTX, save and build the program</h2>
<ul>
<li>Double-click on <b>RTX_Conf_CM.c</b> and configure your clock settings.</li>
<li>Select <b>File</b> and then <b>Save All</b> (you might see an info box that the project is saved in the new .uvprojx format).</li>
<li>Select <b>Project</b> and then <b>Build target</b> or press F7 to build the complete project. It should build without any errors or warnings.</li>
<li>Enter a <b>Debug</b> session (<b>CTRL+F5</b>) and run (<b>F5</b>) the program.</li>
</ul>
<p>Observe how the LEDs are blinking. You can also use the <b>System and Thread Viewer</b> (go to <b>Debug</b> -&gt; <b>OS Support</b> -&gt; <b>System and Thread Viewer</b>) to check how the four threads are waiting for the semaphore token to become available:</p>
<div class="image">
<img src="rtosTut_sempahore_sys_thread_viewer.png" alt="rtosTut_sempahore_sys_thread_viewer.png"/>
<div class="caption">
System and Thread Viewer showing the thread states</div></div>
<h1><a class="anchor" id="RTX_Tutorial_Messages"></a>
Messages</h1>
<p>In this tutorial, a message queue is created. led_Thread2 puts data into the queue, while led_Thread1 reads from the queue. A development board with at least two LEDs is required to run the program.</p>
<h2>Project Setup</h2>
<ol type="1">
<li>Create a project called <b>Message</b> and select your target device.</li>
<li>Select the <b>Board Support:LED (API):LED</b> (if available; otherwise, create two functions LED_On/LED_SetOut) and <b>CMSIS:RTOS (API):Keil RTX</b> software components and resolve any validation problems.</li>
<li>Add the <b>CMSIS-RTOS 'main' function</b> user code template to the project.</li>
<li>Add the <b>CMSIS-RTOS Message Queue</b> user code template to the project.</li>
</ol>
<h2>Adapt MdgQueue.c</h2>
<p>Click on the <b>MdgQueue.c</b> tab and add these lines of code: </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cmsis__os_8h.html">cmsis_os.h</a>&gt;</span>                                      <span class="comment">// CMSIS RTOS header file</span></div>
<div class="line"><span class="preprocessor">#include &quot;Board_LED.h&quot;</span>                                     <span class="comment">// ::Board Support:LED</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">        Message Queue creation &amp; usage</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> LED_Thread1 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);                   <span class="comment">// thread function LED_Thread1</span></div>
<div class="line"><span class="keywordtype">void</span> LED_Thread2 (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);                   <span class="comment">// thread function LED_Thread2</span></div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> tid_LED_Thread1;                                <span class="comment">// thread id LED_Thread1</span></div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> tid_LED_Thread2;                                <span class="comment">// thread id LED_Thread2</span></div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a> (LED_Thread1, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa45a2895ad30c79fb97de18cac7cc19f1" title="priority: normal (default)">osPriorityNormal</a>, 1, 0);         <span class="comment">// thread object LED_Thread1</span></div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a> (LED_Thread2, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa45a2895ad30c79fb97de18cac7cc19f1" title="priority: normal (default)">osPriorityNormal</a>, 1, 0);         <span class="comment">// thread object LED_Thread2</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MSGQUEUE_OBJECTS      16                           // number of Message Queue Objects</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><a class="code" href="cmsis__os_8h.html#ad9ec70c32c6c521970636b521e12d17f" title="Message ID identifies the message queue (pointer to a message queue control block).">osMessageQId</a> Q_LED;                                        <span class="comment">// message queue id</span></div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___message.html#gac9a6a6276c12609793e7701afcc82326" title="Create a Message Queue Definition.">osMessageQDef</a> (Q_LED, MSGQUEUE_OBJECTS, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>);    <span class="comment">// message queue object</span></div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___definitions.html#structos_event" title="Event structure contains detailed information about an event.">osEvent</a> result;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> Init_MsgQueue (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line">  Q_LED = <a class="code" href="group___c_m_s_i_s___r_t_o_s___message.html#gaf3b9345cf426304d46565152bc26fb78" title="Create and Initialize a Message Queue.">osMessageCreate</a>(<a class="code" href="group___c_m_s_i_s___r_t_o_s___message.html#ga2d446a0b4bb90bf05d6f92eedeaabc97" title="Access a Message Queue Definition.">osMessageQ</a>(Q_LED), NULL);        <span class="comment">// create msg queue</span></div>
<div class="line">  <span class="keywordflow">if</span>(!Q_LED) {</div>
<div class="line">    ; <span class="comment">// Message Queue object not created, handle failure</span></div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  tid_LED_Thread1  = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a> (<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(LED_Thread1), NULL);</div>
<div class="line">  <span class="keywordflow">if</span>(!tid_LED_Thread1) <span class="keywordflow">return</span>(-1);</div>
<div class="line">  tid_LED_Thread2  = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a> (<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(LED_Thread2), NULL);</div>
<div class="line">  <span class="keywordflow">if</span>(!tid_LED_Thread2) <span class="keywordflow">return</span>(-1);</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span>(0);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> LED_Thread1(<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    result = <a class="code" href="group___c_m_s_i_s___r_t_o_s___message.html#ga6c6892b8f2296cca6becd57ca2d7e1ae" title="Get a Message or Wait for a Message from a Queue.">osMessageGet</a>(Q_LED,<a class="code" href="cmsis__os_8h.html#a9eb9a7a797a42e4b55eb171ecc609ddb" title="Timeout value.">osWaitForever</a>);            <span class="comment">//wait for a message to arrive</span></div>
<div class="line">    LED_SetOut(result.<a class="code" href="group___c_m_s_i_s___r_t_o_s___definitions.html#a0b9f8fd3645f01d8cb09cae82add2d7f" title="event value">value</a>.<a class="code" href="group___c_m_s_i_s___r_t_o_s___definitions.html#a9e0a00edabf3b8a5dafff624fff7bbfc" title="message as 32-bit value">v</a>);                            <span class="comment">// write the data to the LED&#39;s</span></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> LED_Thread2(<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___message.html#gac0dcf462fc92de8ffaba6cc004514a6d" title="Put a Message to a Queue.">osMessagePut</a>(Q_LED, 0x1, <a class="code" href="cmsis__os_8h.html#a9eb9a7a797a42e4b55eb171ecc609ddb" title="Timeout value.">osWaitForever</a>);               <span class="comment">//Place a value in the message queue</span></div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(500);                                          <span class="comment">//Wait 500 ms</span></div>
<div class="line">    LED_On(3);                                             <span class="comment">//switch on the LED</span></div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___message.html#gac0dcf462fc92de8ffaba6cc004514a6d" title="Put a Message to a Queue.">osMessagePut</a>(Q_LED, 0x2, <a class="code" href="cmsis__os_8h.html#a9eb9a7a797a42e4b55eb171ecc609ddb" title="Timeout value.">osWaitForever</a>);               <span class="comment">//Repeat for other bit patterns</span></div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(500);</div>
<div class="line">    LED_On(3);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___message.html#gac0dcf462fc92de8ffaba6cc004514a6d" title="Put a Message to a Queue.">osMessagePut</a>(Q_LED, 0x0, <a class="code" href="cmsis__os_8h.html#a9eb9a7a797a42e4b55eb171ecc609ddb" title="Timeout value.">osWaitForever</a>);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(500);</div>
<div class="line">    LED_On(3);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___message.html#gac0dcf462fc92de8ffaba6cc004514a6d" title="Put a Message to a Queue.">osMessagePut</a>(Q_LED, 0x3, <a class="code" href="cmsis__os_8h.html#a9eb9a7a797a42e4b55eb171ecc609ddb" title="Timeout value.">osWaitForever</a>);</div>
<div class="line">    <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(500);</div>
<div class="line">    LED_On(3);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Adapt main.c</h2>
<p>Click on the <b>main.c</b> tab and add these lines of code: </p>
<div class="fragment"><div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">   CMSIS-RTOS &#39;main&#39; function template</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define osObjectsPublic                     // define objects in main module</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &quot;osObjects.h&quot;</span>                      <span class="comment">// RTOS object definitions</span></div>
<div class="line"><span class="preprocessor">#include &quot;Board_LED.h&quot;</span>                      <span class="comment">// ::Board Support:LED</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span> Init_MsgQueue (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">   main: initialize and start the system</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">void</span>) {</div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#ga53d078a801022e202e8115c083ece68e" title="Initialize the RTOS Kernel for creating objects.">osKernelInitialize</a> ();                    <span class="comment">// initialize CMSIS-RTOS</span></div>
<div class="line">        </div>
<div class="line">  <span class="comment">// initialize peripherals here</span></div>
<div class="line">        LED_Initialize();</div>
<div class="line">  <span class="comment">// create &#39;thread&#39; functions that start executing,</span></div>
<div class="line">  <span class="comment">// example: tid_name = osThreadCreate (osThread(name), NULL);</span></div>
<div class="line">  Init_MsgQueue();</div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#gaab668ffd2ea76bb0a77ab0ab385eaef2" title="Start the RTOS Kernel.">osKernelStart</a> ();                         <span class="comment">// start thread execution </span></div>
<div class="line">}</div>
</div><!-- fragment --><h2>Configure CMSIS-RTOS RTX, save and build the program</h2>
<ul>
<li>Double-click on <b>RTX_Conf_CM.c</b> and configure your clock settings.</li>
<li>Select <b>File</b> and then <b>Save All</b> (you might see an info box that the project is saved in the new .uvprojx format).</li>
<li>Select <b>Project</b> and then <b>Build target</b> or press F7 to build the complete project. It should build without any errors or warnings.</li>
<li>Enter a <b>Debug</b> session (<b>CTRL+F5</b>) and run (<b>F5</b>) the program.</li>
</ul>
<p>Observe how the two LEDs are blinking. You can also use the <b>System and Thread Viewer</b> (go to <b>Debug</b> -&gt; <b>OS Support</b> -&gt; <b>System and Thread Viewer</b>) to check how thread1 is waiting for mailbox:</p>
<div class="image">
<img src="rtosTut_message_sys_thread_viewer.png" alt="rtosTut_message_sys_thread_viewer.png"/>
<div class="caption">
System and Thread Viewer showing the thread states</div></div>
<h1><a class="anchor" id="RTX_Tutorial_Mailboxes"></a>
Mailbox</h1>
<p>In this tutorial, a mailbox will be used to send data from a producer to a consumer thread. The data will be used to flash LEDs in various ways. A development board with at least two LEDs is required to run the program.</p>
<h2>Project Setup</h2>
<ol type="1">
<li>Create a project called <b>Mailbox</b> and select your target device.</li>
<li>Select the <b>Board Support:LED (API):LED</b> (if available; otherwise, create a function LED_SetOut) and <b>CMSIS:RTOS (API):Keil RTX</b> software components and resolve any validation problems.</li>
<li>Add the <b>CMSIS-RTOS 'main' function</b> user code template to the project.</li>
<li>Add the <b>CMSIS-RTOS Mail Queue</b> user code template to the project.</li>
</ol>
<h2>Adapt MailQueue.c</h2>
<p>Click on the <b>MailQueue.c</b> tab and add these lines of code: </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cmsis__os_8h.html">cmsis_os.h</a>&gt;</span>                                      <span class="comment">// CMSIS RTOS header file</span></div>
<div class="line"><span class="preprocessor">#include &quot;Board_LED.h&quot;</span>                                     <span class="comment">// ::Board Support:LED</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">        Mail Queue creation &amp; usage</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> LED_Producer (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);                  <span class="comment">// thread LED_Producer</span></div>
<div class="line"><span class="keywordtype">void</span> LED_Consumer (<span class="keywordtype">void</span> <span class="keyword">const</span> *argument);                  <span class="comment">// thread LED_Consumer</span></div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> tid_LED_Producer;                               <span class="comment">// thread id LED_Producer</span></div>
<div class="line"><a class="code" href="cmsis__os_8h.html#adfeb153a84a81309e2d958268197617f" title="Thread ID identifies the thread (pointer to a thread control block).">osThreadId</a> tid_LED_Consumer;                               <span class="comment">// thread id LED_Consumer</span></div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a> (LED_Producer, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa45a2895ad30c79fb97de18cac7cc19f1" title="priority: normal (default)">osPriorityNormal</a>, 1, 0);        <span class="comment">// thread object LED_Producer</span></div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaee93d929beb350f16e5cc7fa602e229f" title="Create a Thread Definition with function, priority, and stack requirements.">osThreadDef</a> (LED_Consumer, <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#ga7f2b42f1983b9107775ec2a1c69a849aa45a2895ad30c79fb97de18cac7cc19f1" title="priority: normal (default)">osPriorityNormal</a>, 1, 0);        <span class="comment">// thread object LED_Consumer</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define mail_obj      16                                   // number of Message Queue Objects</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span>{                                           <span class="comment">// object data type</span></div>
<div class="line">  uint8_t LED0;</div>
<div class="line">  uint8_t LED1;</div>
<div class="line">} mail_format;</div>
<div class="line"> </div>
<div class="line"><a class="code" href="cmsis__os_8h.html#a1dac049fb7725a8af8b26c71cbb373b5" title="Mail ID identifies the mail queue (pointer to a mail queue control block).">osMailQId</a> mail_box;                                        <span class="comment">// mail queue id</span></div>
<div class="line"><a class="code" href="group___c_m_s_i_s___r_t_o_s___mail.html#ga58d712b16c0c6668059f509386d1e55b" title="Create a Mail Queue Definition.">osMailQDef</a> (mail_box, mail_obj, mail_format);              <span class="comment">// mail queue object</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> Init_MailQueue (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line">  mail_box = <a class="code" href="group___c_m_s_i_s___r_t_o_s___mail.html#gaa177e7fe5820dd70d8c9e46ded131174" title="Create and Initialize mail queue.">osMailCreate</a>(<a class="code" href="group___c_m_s_i_s___r_t_o_s___mail.html#gad2deeb66d51ade54e63d8f87ff2ec9d2" title="Access a Mail Queue Definition.">osMailQ</a>(mail_box), NULL);        <span class="comment">// create mail queue</span></div>
<div class="line">  tid_LED_Producer = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a> (<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(LED_Producer),  NULL);</div>
<div class="line">  <span class="keywordflow">if</span>(!tid_LED_Producer) <span class="keywordflow">return</span>(-1);</div>
<div class="line">  tid_LED_Consumer = <a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gac59b5713cb083702dce759c73fd90dff" title="Create a thread and add it to Active Threads and set it to state READY.">osThreadCreate</a> (<a class="code" href="group___c_m_s_i_s___r_t_o_s___thread_mgmt.html#gaf0c7c6b5e09f8be198312144b5c9e453" title="Access a Thread definition.">osThread</a>(LED_Consumer),  NULL);</div>
<div class="line">  <span class="keywordflow">if</span>(!tid_LED_Consumer) <span class="keywordflow">return</span>(-1);</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span>(0);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> LED_Producer(<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line">  uint8_t led0[12] = {1,0,0,0,1,1,1,1,0,0,0,0};            <span class="comment">//create the patterns to send to the mailbox</span></div>
<div class="line">  uint8_t led1[12] = {0,2,0,0,0,2,2,2,2,0,0,0};</div>
<div class="line">  uint8_t index;</div>
<div class="line">  mail_format *LEDtx = 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span>(1) {</div>
<div class="line">    <span class="keywordflow">for</span>(index=0;index&lt;12;index++) {</div>
<div class="line">      LEDtx = (mail_format*)<a class="code" href="group___c_m_s_i_s___r_t_o_s___mail.html#gadf5ce811bd6a56e617e902a1db6c2194" title="Allocate a memory block from a mail.">osMailAlloc</a>(mail_box, <a class="code" href="cmsis__os_8h.html#a9eb9a7a797a42e4b55eb171ecc609ddb" title="Timeout value.">osWaitForever</a>); <span class="comment">//allocate a mailslot</span></div>
<div class="line">      LEDtx-&gt;LED0 = led0[index];                           <span class="comment">//Populate it with data</span></div>
<div class="line">      LEDtx-&gt;LED1 = led1[index];</div>
<div class="line">      <a class="code" href="group___c_m_s_i_s___r_t_o_s___mail.html#ga485ef6f81854ebda8ffbce4832181e02" title="Put a mail to a queue.">osMailPut</a>(mail_box, LEDtx);                          <span class="comment">//Post the mail to the mailbox</span></div>
<div class="line">      <a class="code" href="group___c_m_s_i_s___r_t_o_s___wait.html#ga02e19d5e723bfb06ba9324d625162255" title="Wait for Timeout (Time Delay).">osDelay</a>(100);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> LED_Consumer(<span class="keywordtype">void</span> <span class="keyword">const</span> *argument) {</div>
<div class="line">  mail_format  *LEDrx = 0;</div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___definitions.html#structos_event" title="Event structure contains detailed information about an event.">osEvent</a>      evt;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">while</span>(1) {</div>
<div class="line">    evt = <a class="code" href="group___c_m_s_i_s___r_t_o_s___mail.html#gac6ad7e6e7d6c4a80e60da22c57a42ccd" title="Get a mail from a queue.">osMailGet</a>(mail_box, <a class="code" href="cmsis__os_8h.html#a9eb9a7a797a42e4b55eb171ecc609ddb" title="Timeout value.">osWaitForever</a>);              <span class="comment">//Wait until a message arrives</span></div>
<div class="line">    <span class="keywordflow">if</span> (evt.<a class="code" href="group___c_m_s_i_s___r_t_o_s___definitions.html#ad477a289f1f03ac45407b64268d707d3" title="status code: event or error information">status</a> == <a class="code" href="group___c_m_s_i_s___r_t_o_s___status.html#gae2e091fefc4c767117727bd5aba4d99ea15b12e42b42b53f35fb8a2724ad02926" title="function completed; mail event occurred.">osEventMail</a>) {                       <span class="comment">//Check for a valid message</span></div>
<div class="line">      LEDrx = (mail_format*)evt.<a class="code" href="group___c_m_s_i_s___r_t_o_s___definitions.html#a0b9f8fd3645f01d8cb09cae82add2d7f" title="event value">value</a>.<a class="code" href="group___c_m_s_i_s___r_t_o_s___definitions.html#a117104b82864d3b23ec174af6d392709" title="message or mail as void pointer">p</a>;                   <span class="comment">//Set the receive pointer to the mailslot</span></div>
<div class="line">      LED_SetOut(LEDrx-&gt;LED0|LEDrx-&gt;LED1);                 <span class="comment">//Use the data</span></div>
<div class="line">      <a class="code" href="group___c_m_s_i_s___r_t_o_s___mail.html#ga27c1060cf21393f96b4fd1ed1c0167cc" title="Free a memory block from a mail.">osMailFree</a>(mail_box, LEDrx);                         <span class="comment">//Free the mailslot</span></div>
<div class="line">      }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h2>Adapt main.c</h2>
<p>Click on the <b>main.c</b> tab and add these lines of code: </p>
<div class="fragment"><div class="line"><span class="comment">/*----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">   CMSIS-RTOS &#39;main&#39; function template</span></div>
<div class="line"><span class="comment"> *---------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define osObjectsPublic                 // define objects in main module</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &quot;osObjects.h&quot;</span>                  <span class="comment">// RTOS object definitions</span></div>
<div class="line"><span class="preprocessor">#include &quot;stm32f4xx.h&quot;</span>                  <span class="comment">// Device header</span></div>
<div class="line"><span class="preprocessor">#include &quot;Board_LED.h&quot;</span>                  <span class="comment">// ::Board Support:LED</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">int</span> Init_MailQueue (<span class="keywordtype">void</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">   main: initialize and start the system</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">void</span>) {</div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#ga53d078a801022e202e8115c083ece68e" title="Initialize the RTOS Kernel for creating objects.">osKernelInitialize</a> ();                    <span class="comment">// initialize CMSIS-RTOS</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// initialize peripherals here</span></div>
<div class="line">        LED_Initialize();</div>
<div class="line">  <span class="comment">// create &#39;thread&#39; functions that start executing,</span></div>
<div class="line">  <span class="comment">// example: tid_name = osThreadCreate (osThread(name), NULL);</span></div>
<div class="line">  Init_MailQueue();</div>
<div class="line"></div>
<div class="line">  <a class="code" href="group___c_m_s_i_s___r_t_o_s___kernel_ctrl.html#gaab668ffd2ea76bb0a77ab0ab385eaef2" title="Start the RTOS Kernel.">osKernelStart</a> ();                         <span class="comment">// start thread execution </span></div>
<div class="line">}</div>
</div><!-- fragment --><h2>Configure CMSIS-RTOS RTX, save and build the program</h2>
<ul>
<li>Double-click on <b>RTX_Conf_CM.c</b> and configure your clock settings.</li>
<li>Select <b>File</b> and then <b>Save All</b> (you might see an info box that the project is saved in the new .uvprojx format).</li>
<li>Select <b>Project</b> and then <b>Build target</b> or press F7 to build the complete project. It should build without any errors or warnings.</li>
<li>Enter a <b>Debug</b> session (<b>CTRL+F5</b>) and run (<b>F5</b>) the program.</li>
</ul>
<p>Observe how the two LEDs are blinking. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">index</a></li>
    <li class="footer">Generated on Fri Mar 20 2015 14:59:00 for CMSIS-RTOS RTX by ARM Ltd. All rights reserved.
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.2 
	-->
	</li>
  </ul>
</div>
</body>
</html>
